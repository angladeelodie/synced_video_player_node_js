<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Media Player</title>

    <!-- Swiper CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"
    />

    <style>
      * {
        box-sizing: border-box;
      }
      html {
        height: 100%;
        width: 100%;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        height: 100%;
        width: 100%;
        background-color: black;
      }

      h1 {
        font-size: 2.5rem;
      }

      .swiper {
        pointer-events: all;

        width: 100%;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 0;
      }

      .swiper-slide {
        text-align: center;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .project-thumb {
        width: 100%;
        height: auto;
        aspect-ratio: 1;

        object-fit: cover;
        margin-bottom: 10px;
        background: #333;
      }

      .project-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .project-name {
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 6px;
      }

      .project-info .media-badge {
        display: inline-block;
        padding: 4px 10px;
        margin: 2px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }

      #currentProjectInfo {
        padding: 16px;
        margin: 20px 0;
        background: rgba(16, 185, 129, 0.1);
        border-left: 4px solid #10b981;
        border-radius: 12px;
        display: none;
        color: #fff;
      }

      .projects-section {
        pointer-events: none;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }

      .controls {
        pointer-events: all;
        padding: 2rem;

        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        background: linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.98) 0%,
          rgba(0, 0, 0, 0.98) 33%,
          rgba(0, 0, 0, 0) 100%
        );
        backdrop-filter: blur(3px);
        width: 100%;
        gap: 1rem;
      }

      .control-buttons {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        align-items: center;
      }

      .control-button {
        width: 3rem;
        height: 2rem;
        color: white;
        cursor: pointer;
      }

      .control-button img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .control-button button {
        background: transparent;
        width: 100%;
        height: 100%;
        color: white;
        border: none;
        font-size: 1rem;
        cursor: pointer;
      }

      .song-infos {
        width: 100%;
        display: flex;
        flex-direction: column;
        color: white;
      }

      .song-timeline {
        background-color: white;
        height: 2px;
        width: 100%;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="projects-section">
      <!-- Swiper container -->
      <div class="swiper" id="projectsSwiper">
        <div class="swiper-wrapper" id="projectsGrid">
          <div class="swiper-slide empty-state">Chargement des projets...</div>
        </div>
      </div>

      <!-- Control buttons -->

      <div class="controls">
        <div class="song-infos">
          <div id="song-title" class="song-title"></div>
          <div id="song-artist" class="song-artist"></div>
          <div class="song-timeline"></div>
        </div>
        <div class="control-buttons">
          <div class="control-button control-button-prev">
            <img src="./assets/Back.svg" alt="" />
          </div>
          <div class="control-button">
            <button id="play">
              <img src="./assets/Play.svg" alt="" />
            </button>
            <button id="pause" class="hidden">
              <img src="./assets/Pause.svg" alt="" />
            </button>
          </div>
          <div class="control-button control-button-next">
            <img src="./assets/Next.svg" alt="" />
          </div>

          <div class="hidden">
            <button id="stop">‚èπ</button>
            <button id="rewind">‚è™</button>
            <button id="forward">‚è©</button>
            <button id="reload">üîÑ</button>
            <span id="connectionStatus" class="status disconnected"
              >D√©connect√©</span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <script>
      // Initialize Swiper
      const swiper = new Swiper("#projectsSwiper", {
        slidesPerView: 1,
        spaceBetween: 0,
        navigation: {
          nextEl: ".control-button-next",
          prevEl: ".control-button-prev",
        },
      });

      // WebSocket and project loading code remains mostly unchanged
      const ws = new WebSocket("ws://localhost:3000");
      const connectionStatus = document.getElementById("connectionStatus");
      const clientsList = document.getElementById("clientsList");
      const clientCount = document.getElementById("clientCount");

      ws.onopen = () => {
        connectionStatus.textContent = "Connect√©";
        connectionStatus.className = "status connected";
        ws.send(JSON.stringify({ type: "identify", role: "commander" }));
      };
      ws.onclose = () => {
        connectionStatus.textContent = "D√©connect√©";
        connectionStatus.className = "status disconnected";
      };
      // ws.onmessage = (event) => {
      // 	const data = JSON.parse(event.data);
      // 	if (data.type === "clientsUpdate") updateClientsList(data.clients, data.total);
      // };

      // function updateClientsList(clients, total) {
      // 	clientCount.textContent = total;
      // 	if (clients.length === 0) {
      // 		clientsList.innerHTML = '<li class="empty-state">Aucun appareil connect√©</li>';
      // 		return;
      // 	}
      // 	clientsList.innerHTML = clients.map(c => `
      // 		<li>
      // 			<div>Appareil #${c.id}</div>
      // 			<div>${c.isMaster ? 'MASTER' : c.isCommander ? 'Commander' : ''}</div>
      // 		</li>
      // 	`).join('');
      // }

      const playButton = document.getElementById("play");
      const pauseButton = document.getElementById("pause");
      const stopButton = document.getElementById("stop");
      const rewindButton = document.getElementById("rewind");
      const forwardButton = document.getElementById("forward");
      const reloadButton = document.getElementById("reload");

      playButton.onclick = () =>
        ws.send(JSON.stringify({ type: "play", video: "video-vertical" }));
      pauseButton.onclick = () => ws.send(JSON.stringify({ type: "pause" }));
      stopButton.onclick = () => ws.send(JSON.stringify({ type: "stop" }));
      rewindButton.onclick = () => ws.send(JSON.stringify({ type: "rewind" }));
      forwardButton.onclick = () =>
        ws.send(JSON.stringify({ type: "forward" }));
      reloadButton.onclick = () => ws.send(JSON.stringify({ type: "reload" }));

      // Load projects
      async function loadProjects() {
        try {
          const response = await fetch("/api/media");
          const data = await response.json();
		  console.log(data);
          const projects = data.summary.projects || [];

          const projectsGrid = document.getElementById("projectsGrid");

          if (!projects.length) {
            projectsGrid.innerHTML =
              '<div class="swiper-slide empty-state">Aucun projet trouv√©</div>';
            return;
          }

          // Clear existing slides
          projectsGrid.innerHTML = "";

          projects.forEach((p) => {
            const projectName = p.name;
            const projectCatalog = data.catalog[projectName] || {};
            console.log(data.catalog);

            // Loop through albums
            if (projectCatalog.phone) {
              Object.keys(projectCatalog.phone).forEach((albumKey, index) => {
                const albumMedia = projectCatalog.phone[albumKey];

                // Create a slide for each album media (name + video only)
                const slideHTML = `
                <div class="swiper-slide project-card" data-project="${projectName}" data-album="${albumKey}" data-index="${index}">
                  <video class="project-video" muted loop autoplay>
                    <source src="${albumMedia.url}" type="video/mp4">
                  </video>
                  <div class="project-name">${projectName} - Album ${albumKey}</div>
                </div>
              `;
                projectsGrid.insertAdjacentHTML("beforeend", slideHTML);
              });

              document.getElementById("song-title").textContent = projectName;
              document.getElementById("song-artist").textContent = projectName;
            }
          });

          // Optional: click handler if you want to track selected album
          document.querySelectorAll(".project-card").forEach((card) => {
            console.log("clickkkk");
            card.onclick = () => {
				console.log(card)
              const projectName = card.dataset.project;
              const albumKey = card.dataset.album;
              const index = card.dataset.index;
              selectAlbum(projectName, albumKey, index);
            };
          });

          swiper.update();
        } catch (err) {
          console.error(err);
        }
      }

      let selectedProject = null;

      async function selectAlbum(projectName, albumKey, index) {
        console.log("select album", projectName, albumKey, index);
        selectedProject = projectName;
        document.getElementById("song-title").textContent = projectName;
        document.getElementById("song-artist").textContent = projectName;

        // Send project selection via WebSocket
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "setSource", source: projectName }));
        }
      }

      window.onload = loadProjects;
    </script>
  </body>
</html>
